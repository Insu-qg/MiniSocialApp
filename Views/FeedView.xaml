<Window x:Class="MiniSocialApp.Views.FeedView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:local="clr-namespace:MiniSocialApp.Converters"
        Title="Fil d'actualité"
        Height="650"
        Width="500"
        WindowStartupLocation="CenterScreen"
        Background="#1e1e2f"
        ResizeMode="CanMinimize">

    <Window.Resources>
        <local:CommentConverter x:Key="CommentConverter"/>
        <local:StringNullOrEmptyToVisibilityConverter x:Key="StringNullOrEmptyToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Liste des posts -->
        <ScrollViewer x:Name="FeedScrollViewer" Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Posts}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border BorderThickness="0,0,0,1"
                                BorderBrush="#4a4a6a"
                                Padding="12"
                                Margin="0,0,0,18"
                                Background="#232344"
                                CornerRadius="8">
                            <StackPanel>
                                <!-- Auteur et date -->
                                <DockPanel LastChildFill="False" Margin="0,0,0,4">
                                    <TextBlock Text="{Binding Username}"
                                               FontWeight="Bold"
                                               Foreground="#50c878"
                                               FontSize="15"
                                               DockPanel.Dock="Left"/>
                                    <TextBlock Text="{Binding CreatedAt}"
                                               FontSize="11"
                                               Foreground="Gray"
                                               DockPanel.Dock="Right"
                                               Margin="10,0,0,0"
                                               VerticalAlignment="Bottom"/>
                                </DockPanel>

                                <!-- Contenu du post -->
                                <TextBlock Text="{Binding Content}"
                                           TextWrapping="Wrap"
                                           Margin="0,2,0,8"
                                           Foreground="White"
                                           FontSize="14"/>

                                <!-- Actions (Like + compteur) -->
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                    <Button Content="👍 Like"
                                            Width="65"
                                            Height="28"
                                            Padding="0"
                                            FontWeight="Bold"
                                            Command="{Binding DataContext.LikePostCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Margin="0,0,8,0">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="#2e2e3e"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasLiked}" Value="True">
                                                        <Setter Property="Background" Value="#50c878"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <TextBlock Text="{Binding Likes}"
                                               VerticalAlignment="Center"
                                               Foreground="White"
                                               FontWeight="Bold"
                                               FontSize="13"
                                               Margin="4,0,0,0"/>
                                    <TextBlock Text="like(s)"
                                               VerticalAlignment="Center"
                                               Foreground="Gray"
                                               FontSize="12"
                                               Margin="2,0,0,0"/>
                                </StackPanel>

                                <!-- Commentaires -->
                                <ItemsControl ItemsSource="{Binding Comments}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock FontSize="11"
                                                       Foreground="LightGray"
                                                       Margin="0,0,0,2">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} : {1}">
                                                        <Binding Path="User.Username"/>
                                                        <Binding Path="Content"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.Margin>
                                        <Thickness Left="8" Top="2" Right="0" Bottom="0"/>
                                    </ItemsControl.Margin>
                                </ItemsControl>

                                <!-- Ajouter un commentaire -->
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                    <TextBox x:Name="CommentBox"
                                             Width="240"
                                             Height="32"
                                             Background="#2e2e3e"
                                             Foreground="White"
                                             BorderBrush="#4a4a6a"
                                             Margin="0,0,8,0"
                                             VerticalContentAlignment="Center"
                                             FontSize="13"/>
                                    <Button Content="Commenter"
                                            Width="90"
                                            Height="32"
                                            FontWeight="Bold"
                                            Command="{Binding DataContext.AddCommentCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Margin="0"
                                            Padding="0">
                                        <Button.CommandParameter>
                                            <MultiBinding Converter="{StaticResource CommentConverter}">
                                                <Binding ElementName="CommentBox" Path="Text"/>
                                                <Binding/>
                                            </MultiBinding>
                                        </Button.CommandParameter>
                                    </Button>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Nouveau post avec placeholder WPF -->
        <Grid Grid.Row="1" Height="50" Margin="0,10,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="110"/>
            </Grid.ColumnDefinitions>
            <Grid>
                <TextBox x:Name="NewPostBox"
                         Text="{Binding NewPostContent, UpdateSourceTrigger=PropertyChanged}"
                         Background="#2e2e3e"
                         Foreground="White"
                         BorderBrush="#4a4a6a"
                         VerticalContentAlignment="Center"
                         FontSize="14"
                         Padding="8,0,8,0"/>
                <TextBlock Text="Écrire un nouveau post..."
                           Foreground="Gray"
                           IsHitTestVisible="False"
                           VerticalAlignment="Center"
                           Margin="12,0,0,0"
                           FontSize="13"
                           Visibility="{Binding Text, ElementName=NewPostBox, Converter={StaticResource StringNullOrEmptyToVisibilityConverter}}"/>
            </Grid>
            <Button Content="Poster"
                    Grid.Column="1"
                    Width="100"
                    Height="45"
                    Background="#50c878"
                    Foreground="White"
                    FontWeight="Bold"
                    BorderThickness="0"
                    Margin="10,0,0,0"
                    Command="{Binding AddPostCommand}"/>
        </Grid>
    </Grid>
</Window>
